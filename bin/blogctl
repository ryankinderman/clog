#!/usr/bin/env ruby
require File.expand_path(File.dirname(__FILE__) + "/../init")
require 'xmlrpc/client'

def dump(blog_name, path, post)
  file_name = post["postid"] + "_" + post["link"].match(/\/([^\/]+)$/)[1]
  file_path = path + "/#{file_name}"
  File.open(file_path, "w") do |f|
    PostWriter.write(f, blog_name, post)
  end    
end

def run
  begin
    p = CommandLine.parse($*)
  rescue StandardError => e
    puts e.message
    puts CommandLine.syntax
    return
  end

  port = 80
  blog_id = 1
  
  client = XMLRPC::Client.new(p.host, p.xmlrpc_path, port)
  blog = Blog.new(client, blog_id, p.login, p.password)
  
  blog.all_posts.each do |post|
    dump(p.host, p.post_path, post)
  end
end

run
